pipeline {
  agent any
  environment {
    IMAGE_NAME = "ci-docker-image"
    DOCKER_REPO = "reshars/ci-docker-repo"
    TAG = "latest"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Ensure no bad docker creds') {
      steps {
        bat """
          rem attempt logout to clear any bad saved creds (ignore errors)
          docker logout || echo Logout returned non-zero, continuing...
        """
      }
    }

    stage('Build Docker Image') {
      steps {
        bat """
          docker build -t %IMAGE_NAME%:%TAG% .
        """
      }
    }

    stage('Show Docker Images') {
      steps {
        bat "docker images"
      }
    }

    stage('Docker Login and Push') {
      steps {
        // Use Jenkins stored credentials (username/password where password is Docker Hub token)
        withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          bat """
            echo %DOCKER_PASS% | docker login --username %DOCKER_USER% --password-stdin
            docker tag %IMAGE_NAME%:%TAG% %DOCKER_USER%/%DOCKER_REPO%:%TAG%
            docker push %DOCKER_USER%/%DOCKER_REPO%:%TAG%
          """
        }
      }
    }
  }
  post {
    always { echo "Pipeline finished." }
  }
}
